# PRD｜VS Code 分组书签插件（GroupBookmarks）

## 1. 背景 & 问题定义

### 1.1 背景

在阅读和维护中大型代码库时，开发者往往需要**按"流程 / 视角"来理解代码**，而不是按文件结构。例如：

* **流程视角**：登录 → 校验 → 参数构建 → 下游调用
* **风险视角**：异常 → 回滚 → 补偿 → 日志
* **架构视角**：核心接口 → 扩展点 → 实现类

现有 VS Code 插件存在明显缺口：

* **Bookmarks 插件**：只能按文件组织，**无法按逻辑流程分组**
* **TODO / 注释类插件**：**会污染源码**，团队协作时产生干扰
* **笔记类插件**：**跳转与代码关联弱**，维护成本高

### 1.2 核心问题

> 是否能在 **不改动源码** 的前提下，
> 对代码位置建立 **"可多视角分组、可排序、可快速跳转、可视化标记"** 的书签体系？

---

## 2. 产品定位

### 2.1 一句话定位

> **这是一个为"理解代码流程"而生的个人书签工具，而不是 TODO 管理器。**

### 2.2 产品目标（Goals）

* ✅ **零污染**：不修改任何源码文件
* ✅ **多视角**：同一代码位置可归入多个分组（流程视角 / 风险视角等）
* ✅ **可视化**：代码编辑器左侧 Gutter 显示书签标记，分组用颜色区分
* ✅ **灵活排序**：支持拖拽排序和按名称自动排序
* ✅ **持久化**：用户自选备份目录，支持导入导出跨机器使用

### 2.3 非目标（Non‑Goals）

* ❌ **不做团队协作**：本质是个人工具，不考虑云同步（V1）
* ❌ **不做语义分析**：不尝试理解代码含义
* ❌ **不做 100% 抗重构**：行号漂移采用弱定位策略（够用即可）

---

## 3. 目标用户 & 使用场景

### 3.1 目标用户

* **中高级开发者**：经常阅读、维护复杂业务代码
* **代码 Reviewer**：需要按流程梳理代码逻辑
* **架构师**：需要从多个视角理解系统结构

### 3.2 核心使用场景

#### 场景 1：按流程阅读代码

**用户故事**：
```
作为 后端开发工程师
我想要 按"订单创建流程"组织相关代码位置
以便于 快速理解跨多个文件的业务逻辑
```

**验收标准**：
- 创建「订单创建流程」分组
- 依次添加：参数校验 → 库存检查 → 价格计算 → 订单入库 → 通知下游
- 拖拽调整顺序，使其符合执行顺序
- 点击书签能直接跳转到对应代码位置

---

#### 场景 2：同一代码的多视角分析

**用户故事**：
```
作为 代码审查员
我想要 将同一行代码同时加入"业务流程"和"异常风险点"两个分组
以便于 从不同角度分析代码
```

**验收标准**：
- 同一行代码（如 `try-catch` 块）可被添加到多个分组
- 在不同分组中可以有不同的标题（如："订单入库" vs "异常回滚点"）
- Gutter 标记能显示该行属于多个分组

---

#### 场景 3：跨机器导入书签

**用户故事**：
```
作为 多设备工作的开发者
我想要 将家里电脑的书签导出，在公司电脑导入
以便于 在不同环境继续代码阅读工作
```

**验收标准**：
- 导出为 JSON 文件
- 在另一台机器的相同项目中导入
- 书签能正确映射到对应代码位置（路径兼容性处理）

---

## 4. 核心概念设计

### 4.1 数据模型（多对多关系）

#### Bookmark（书签）

```typescript
interface Bookmark {
  id: string;                   // 唯一标识
  fileUri: string;              // 文件路径（相对于 workspace）
  line: number;                 // 行号（1-indexed）
  column?: number;              // 列号（可选）
  decoration?: DecorationInfo;  // VS Code Decoration 句柄（用于跟踪行号变化）
}
```

#### BookmarkGroup（书签与分组的关联）

```typescript
interface BookmarkGroup {
  bookmarkId: string;
  groupId: string;
  title: string;               // 在该分组中的标题（用户自定义）
  order: number;               // 在该分组中的排序
  createdAt: number;           // 添加时间戳
}
```

#### Group（分组）

```typescript
interface Group {
  id: string;
  name: string;
  color: string;               // 分组颜色（用于 Gutter 装饰）
  order: number;               // 分组排序
  sortMode: 'custom' | 'name'; // 排序模式：自定义拖拽 or 按名称
}
```

**关键设计点**：
- **多对多关系**：Bookmark ↔ Group 通过 `BookmarkGroup` 中间表关联
- **装饰器跟随**：使用 VS Code `TextEditorDecorationType` 实现行号自动跟踪（参考 Bookmark 插件）
- **分组颜色**：每个分组可设置独立颜色，在 Gutter 显示

---

### 4.2 存储策略

#### V1：工作区本地存储

* **主存储**：用户自选目录（如项目根目录 `.vscode/groupbookmarks/`）
* **格式**：JSON 文件
  - `bookmarks.json`：Bookmark 数据
  - `groups.json`：Group 数据
  - `relations.json`：BookmarkGroup 关联关系

#### 容灾备份

* **备份触发**：每次修改后自动备份到 `.vscode/groupbookmarks/backup/`
* **保留策略**：最近 5 个版本

---

## 5. 功能需求（Functional Requirements）

### 5.1 分组管理

#### 功能点

* ✅ 新建分组（输入名称、选择颜色）
* ✅ 重命名分组
* ✅ 删除分组（**删除分组时同时删除所有关联的 BookmarkGroup 记录**）
* ✅ 拖拽调整分组顺序
* ✅ 切换排序模式（自定义 / 按名称）

#### 验收标准

**场景**：删除已有 10 个书签的分组
- **当**：右键点击分组 → 选择 Delete
- **那么**：弹出确认对话框："分组「XXX」包含 10 个书签，确认删除？"
- **结果**：确认后，分组及所有关联的 BookmarkGroup 记录被删除，但底层 Bookmark 数据保留（可能被其他分组引用）

---

### 5.2 书签管理

#### 功能点

* ✅ **添加书签到当前选中分组**
  - 在代码编辑器中，光标定位到目标行
  - 触发命令 `Add Bookmark to Group`
  - 弹窗：输入标题（可选，**默认取当前行前 50 字符**）
  - 选择分组（默认为侧边栏当前选中的分组）
  
* ✅ **将已有书签添加到其他分组**
  - 右键点击书签 → `Add to Another Group`
  - 选择目标分组，输入新标题
  
* ✅ **重命名书签**（在特定分组中的标题）
  - 右键书签 → Rename
  - 只修改该书签在当前分组中的 `title`
  
* ✅ **从分组中移除书签**
  - 右键书签 → Remove from This Group
  - 如果该书签不属于任何分组，则删除底层 Bookmark 数据
  
* ✅ **完全删除书签**
  - 右键书签 → Delete Bookmark
  - 删除该书签在所有分组中的关联，并删除底层 Bookmark 数据

#### 验收标准

**场景**：同一行代码添加到两个分组
- **当**：在 `user.ts:12` 添加书签到「登录流程」，标题为"参数校验"
- **当**：再次在 `user.ts:12` 添加书签到「风险点」，标题为"SQL 注入风险"
- **那么**：
  - TreeView 中两个分组都显示该书签，但标题不同
  - Gutter 显示两个分组的颜色标记（叠加显示）
  - 点击任一书签都跳转到 `user.ts:12`

---

### 5.3 排序与移动

#### 功能点

* ✅ **拖拽排序**（分组内）
  - 拖动书签调整在当前分组内的顺序
  - 自动更新 `BookmarkGroup.order`
  
* ✅ **拖拽移动**（跨分组）
  - 将书签拖到另一个分组
  - 弹窗询问："移动 or 复制？"
  - 移动：删除原分组关联，新增目标分组关联
  - 复制：保留原分组关联，新增目标分组关联
  
* ✅ **按名称排序**
  - 分组右键 → `Sort by Name`
  - 切换分组的 `sortMode` 为 `name`
  - 自动按书签标题字母序排列

#### 验收标准

**场景**：拖拽书签到另一分组
- **当**：将「登录流程」中的"参数校验"拖到「风险点」分组
- **那么**：弹窗："移动 or 复制？"
- **如果选择移动**：书签从「登录流程」消失，出现在「风险点」
- **如果选择复制**：书签同时存在于两个分组，标题可能不同

---

### 5.4 跳转与可视化

#### Gutter 装饰器（代码左侧标记）

* ✅ **单分组标记**：显示该分组颜色的圆点 ●
* ✅ **多分组标记**：显示渐变色或多个圆点叠加
* ✅ **Hover 提示**：鼠标悬停显示：
  ```
  📌 书签：
  • 登录流程 > 参数校验
  • 风险点 > SQL 注入风险
  
  [点击跳转到侧边栏]
  ```

#### 跳转行为

* ✅ **点击书签跳转**：打开文件并定位到目标行
* ✅ **行号漂移处理**：
  - VS Code Decoration API 自动跟踪行号变化（参考 Bookmarks 插件）
  - 如果文件被删除，书签标记为"失效"（红色警告图标）

#### 验收标准

**场景**：代码前方插入新行
- **当**：在 `user.ts:10` 有书签，然后在第 8 行插入 3 行新代码
- **那么**：书签自动更新到 `user.ts:13`（Decoration API 跟踪）
- **验证**：点击书签仍能正确跳转

---

### 5.5 导入 / 导出

#### 导出功能

* ✅ **导出范围**：当前 workspace 的所有书签数据
* ✅ **导出格式**：
  ```json
  {
    "version": "1.0.0",
    "workspace": "GroupBookmarks",
    "exportedAt": "2026-02-03T22:30:00Z",
    "bookmarks": [...],
    "groups": [...],
    "relations": [...]
  }
  ```
* ✅ **路径处理**：所有 `fileUri` 使用相对路径（相对于 workspace 根目录）

#### 导入功能

* ✅ **冲突处理**：
  - 如果分组名称冲突，自动重命名为 `XXX (imported)`
  - 如果书签位置冲突（同一行已有书签），询问用户：合并 or 跳过
  
* ✅ **路径映射**：
  - 如果文件路径不存在，标记为"待修复"
  - 提供批量路径映射工具（如 Windows → Linux 路径转换）

#### 验收标准

**场景**：跨操作系统导入
- **当**：在 Windows 上导出（路径如 `src\user.ts`）
- **当**：在 Linux 上导入到相同 workspace
- **那么**：自动转换路径分隔符为 `src/user.ts`
- **验证**：书签能正确跳转

---

## 6. 交互 & UI 设计

### 6.1 侧边栏 TreeView

```
🔴 登录流程 [5]                    ← 分组（红色圆点表示颜色）
  ├─ 参数校验     (user.ts:12)     ← 书签
  ├─ Token 生成   (auth.ts:45)
  └─ 权限检查     (role.ts:88)

🔵 风险点 [3] 
  ├─ SQL 注入风险 (user.ts:12)     ← 同一行代码，不同标题
  └─ 异常回滚     (order.ts:102)

🟢 架构扩展点 [2]
  ├─ IUserService (interface.ts:5)
  └─ UserImpl     (impl.ts:20)
```

**交互细节**：
- 分组名称后显示书签数量 `[5]`
- 分组前显示颜色图标（可自定义 8 种预设颜色）
- 书签显示：标题 + 文件名:行号

---

### 6.2 右键菜单

#### 分组右键菜单

* Rename Group
* Change Color
* Sort by Name / Custom Order
* Delete Group（显示书签数量警告）

#### 书签右键菜单

* Jump to Code
* Rename（在当前分组中的标题）
* Add to Another Group
* Remove from This Group
* Delete Bookmark（从所有分组删除）
* Copy File Path

---

### 6.3 命令面板（Command Palette）

| 命令                        | 快捷键建议 | 说明                  |
| --------------------------- | ---------- | --------------------- |
| `Add Bookmark to Group`     | `Ctrl+K B` | 在当前行添加书签      |
| `Create Group`              | -          | 新建分组              |
| `Export Bookmarks`          | -          | 导出为 JSON           |
| `Import Bookmarks`          | -          | 从 JSON 导入          |
| `Focus Bookmark View`       | `Ctrl+K V` | 聚焦到侧边栏          |
| `Toggle Gutter Decorations` | -          | 显示/隐藏 Gutter 标记 |

---

### 6.4 Gutter 装饰器设计

#### 单分组标记

```
10 │ ● function validateUser() {    ← 红色圆点
11 │   const valid = checkParams();
```

#### 多分组标记（同一行属于 2 个分组）

```
10 │ ●● function validateUser() {   ← 红色+蓝色叠加
```

#### Hover 提示

```
┌────────────────────────────────┐
│ 📌 此行包含 2 个书签:            │
│                                  │
│ 🔴 登录流程                      │
│    └─ 参数校验                   │
│                                  │
│ 🔵 风险点                        │
│    └─ SQL 注入风险               │
│                                  │
│ [Ctrl+Click 跳转到侧边栏]        │
└────────────────────────────────┘
```

---

## 7. 技术方案要点

### 7.1 核心 VS Code API

| API                          | 用途                          |
| ---------------------------- | ----------------------------- |
| `TreeDataProvider`           | 侧边栏树形结构                |
| `TreeDragAndDropController`  | 拖拽排序                      |
| `TextEditorDecorationType`   | Gutter 装饰器（跟踪行号变化） |
| `workspace.onDidRenameFiles` | 监听文件重命名，更新 fileUri  |
| `workspace.fs`               | 读写 JSON 文件                |

### 7.2 定位策略

#### 主策略：Decoration API 自动跟踪

```typescript
// 创建书签时
const decoration = vscode.window.createTextEditorDecorationType({
  gutterIconPath: getColorIcon(group.color),
  gutterIconSize: 'contain'
});

const range = new vscode.Range(line, 0, line, 0);
editor.setDecorations(decoration, [range]);

// VS Code 会自动更新 range 的行号（即使插入/删除行）
```

#### 备用策略：文件变更监听

* 监听 `workspace.onDidChangeTextDocument`
* 如果 Decoration 被销毁（文件关闭重开），从存储恢复

---

### 7.3 性能优化

#### 懒加载策略

* TreeView 只渲染可见节点（VS Code 默认支持）
* Gutter 装饰器只在打开的编辑器中激活
* 大于 100 个书签时，分组默认折叠

#### 内存优化

* 使用 WeakMap 缓存 Decoration 对象
* 编辑器关闭时清理对应的 Decoration

---

## 8. MVP 范围（V1）

### ✅ 必须实现

* 分组管理（CRUD + 颜色）
* 书签管理（多对多关系）
* Gutter 装饰器（Decoration API）
* 拖拽排序（自定义 / 按名称）
* 导入 / 导出（跨机器使用）
* 文件重命名跟踪

### ⏸️ 可延后到 V2

* 全局搜索书签
* 书签历史记录（撤销/重做）
* 批量操作（批量移动、批量删除）
* 分组标签（Tag）系统

---

## 9. 成功指标（Success Metrics）

### 功能指标

* ✅ 支持 100+ 书签仍流畅使用（懒加载保证）
* ✅ 用户可在 **3 步内**完成：选分组 → 添加书签 → 跳转
* ✅ 不出现源码 diff（零污染）

### 用户体验指标

* ✅ 添加书签响应时间 < 100ms
* ✅ 跳转准确率 > 95%（行号漂移场景）
* ✅ Gutter 装饰器刷新延迟 < 200ms

---

## 10. 风险 & 应对

| 风险                      | 应对                                           |
| ------------------------- | ---------------------------------------------- |
| Decoration API 学习成本高 | 参考 Bookmarks 插件源码，复用成熟方案          |
| 文件重命名/移动丢失书签   | 监听 `onDidRenameFiles` 事件，自动更新 fileUri |
| 跨平台路径兼容性问题      | 统一使用 `/` 分隔符，导入时自动转换            |
| 用户误删数据              | 自动备份最近 5 个版本                          |
| TreeView 拖拽体验不佳     | 提供键盘快捷键（Move Up / Move Down）作为补充  |

---

## 11. 后续演进方向（V2+）

### 功能增强

* 📌 **书签笔记**：为书签添加 Markdown 笔记
* 🔍 **全局搜索**：跨分组搜索书签
* 📊 **统计面板**：每个分组的书签数量、最近访问等
* 🏷️ **标签系统**：书签支持多标签过滤

### 协作功能（慎重考虑）

* 📤 **只读分享**：生成公开链接，他人可查看书签但不能编辑
* ☁️ **云同步**：可选的 GitHub Gist 同步

---

## 附录：用户故事汇总

### Epic 1：分组管理

| ID   | 用户故事                                                       | 优先级 |
| ---- | -------------------------------------------------------------- | ------ |
| US-1 | 作为开发者，我想要创建分组并设置颜色，以便于视觉区分不同流程   | P0     |
| US-2 | 作为开发者，我想要拖拽调整分组顺序，以便于控制显示优先级       | P1     |
| US-3 | 作为开发者，我想要删除分组时看到书签数量警告，以便于避免误操作 | P0     |

### Epic 2：书签管理

| ID   | 用户故事                                                             | 优先级 |
| ---- | -------------------------------------------------------------------- | ------ |
| US-4 | 作为开发者，我想要将同一行代码添加到多个分组，以便于多视角分析       | P0     |
| US-5 | 作为开发者，我想要在 Gutter 看到书签标记，以便于快速识别重要代码位置 | P0     |
| US-6 | 作为开发者，我想要自定义书签标题，以便于记录代码含义                 | P0     |

### Epic 3：导入导出

| ID   | 用户故事                                                   | 优先级 |
| ---- | ---------------------------------------------------------- | ------ |
| US-7 | 作为开发者，我想要导出书签为 JSON，以便于在其他机器使用    | P0     |
| US-8 | 作为开发者，我想要导入时自动处理路径冲突，以便于跨平台使用 | P1     |

---

**文档版本**：v2.0 (终版)  
**最后更新**：2026-02-03  
**维护者**：产品经理
