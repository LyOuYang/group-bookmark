name: Release

on:
  push:
    tags:
      - 'v*' # å½“æ¨é€ v å¼€å¤´çš„ tag æ—¶è§¦å‘ï¼ˆä¾‹å¦‚ v1.0.0ï¼‰

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: å®‰è£…ä¾èµ–
        run: npm ci

      - name: ç¼–è¯‘é¡¹ç›®
        run: npm run compile

      - name: æ‰“åŒ… VSIX
        run: npm run package

      - name: è·å–ç‰ˆæœ¬å·
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: æŸ¥æ‰¾ VSIX æ–‡ä»¶
        id: find_vsix
        run: |
          VSIX_FILE=$(ls *.vsix | head -n 1)
          echo "VSIX_FILE=$VSIX_FILE" >> $GITHUB_OUTPUT
          echo "æ‰¾åˆ° VSIX æ–‡ä»¶: $VSIX_FILE"

      - name: åˆ›å»º Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ steps.get_version.outputs.VERSION }}
          body: |
            ## ğŸ‰ Group Bookmarks v${{ steps.get_version.outputs.VERSION }}
            
            ### å®‰è£…æ–¹å¼
            1. ä¸‹è½½ä¸‹æ–¹çš„ `.vsix` æ–‡ä»¶
            2. æ‰“å¼€ VS Code
            3. æŒ‰ `Ctrl+Shift+P` æˆ– `Cmd+Shift+P` æ‰“å¼€å‘½ä»¤é¢æ¿
            4. è¾“å…¥ "Extensions: Install from VSIX..."
            5. é€‰æ‹©ä¸‹è½½çš„ `.vsix` æ–‡ä»¶
            
            ### ç‰¹æ€§
            - ğŸ“‚ å¤šç»´åˆ†ç»„ç®¡ç†
            - ğŸ‘ï¸ å¯è§†åŒ–å¢å¼ºï¼ˆGhost Textï¼‰
            - ğŸ–±ï¸ æé€Ÿäº¤äº’ï¼ˆä»£ç é¢„è§ˆã€æ‹–æ‹½ï¼‰
            - ğŸ”„ å¯¼å…¥/å¯¼å‡ºåŠŸèƒ½
            
            è¯¦ç»†åŠŸèƒ½è¯·æŸ¥çœ‹ [README](https://github.com/${{ github.repository }})
          draft: false
          prerelease: false

      - name: ä¸Šä¼  VSIX åˆ° Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./${{ steps.find_vsix.outputs.VSIX_FILE }}
          asset_name: ${{ steps.find_vsix.outputs.VSIX_FILE }}
          asset_content_type: application/vsix
